# 从 0 开始学微服务

## 从入门到放弃

- 团队能力可能会制约你们部门发展微服务架构
- 团队人数多起来之后，单体应用发布就会变得非常麻烦，忘记合并代码啦、更新依赖啦、打包啦
- 步骤为 `单体应用 --> 微服务架构 --> 容器化应用 --> DevOps`

## 从单体应用走向服务化

- 单体应用内部的功能有可能会相互影响
- 服务化简单的讲就是将功能模块拆分单独部署单独运维
- 拆分方法是按照业务进行拆分或者按照公共且独立功能维度进行拆分

### 拆分的前置条件

- 服务如何定义，http 还是 rpc？
- 服务如何发布和订阅，注册中心？
- 服务如何监控，需要覆盖业务埋点、数据收集、数据处理、最后到数据展示的全链路
- 服务如何治理，可以设定性能阀值，超过过久就直接返回（熔断）
- 故障如何进行定位
- 建议每个人不要负责超过 3 个大服务

## 初探微服务

### 服务描述

- 描述方式，主要有 RESTful API( Swagger 进行管理)、XML 配置（RPC）以及 IDL 文件（ Thrift 和 gRPC ）三种

### 注册中心

- 服务者根据配置提供自己的信息
- 消费者根据配置获取服务
- 注册中心在服务新增或者销毁时，需要通知消费者
- 监控调用情况

### 服务框架

- 确定采用的协议
- 数据传输方式，多路复用还是单链接，是同步还是异步
- 数据压缩采用什么格式[JSON/JAVA 对象/Protobuf]

### 服务监控

- 指标收集
- 数据处理
- 数据展示

### 服务追踪

- 服务消费者发起请求前，必须提供 requestid
- 若服务提供者有再发起请求，那么在拼接上自己的 requestid，从而实现追踪

### 服务治理

保证在异常情况下，服务人仍然能够运行

- 单机故障，自动去除故障节点
- 单 IDC 故障，自动切换
- 依赖服务不可用，熔断

## 如何发布和引用微服务

还是选用上述的三种方式，如果服务大部分是基于 java 那么实用 xml 最好，跨语言就实用 IDL，需要对外就实用 RESTful api,但是 IDL 虽然跨语言，但是不适合字段多又多变的场景

- [Motan](https://www.cnblogs.com/hjcenry/p/5856933.html)

## 5 如何注册和发现微服务

### 注册中心原理

需要提供以下 API

- 服务注册/反注册接口
- 服务订阅/变更接口
- 心跳汇报接口

集群部署

- 选取 leader
- leader 负责数据更新操作

目录存储

- zookeeper 把他们叫作 znode
- znode 可以保存数据和子 znode

服务状态检测

- 其实就是通过唯一 sessionid 去进行判断

服务状态变更

- 通过 Watcher 机制，监听改变获取最新数据

白名单机制

- 用于权限控制

## 6 如何实现 RPC 远程服务调用

弄清楚四个问题

- 如何建立网络连接 http/socket
- 如何处理请求 BIO（同步阻塞）/NIO（同步非阻塞）/AIO（异步非阻塞）
- 采用什么传输协议
- 如何序列化和反序列化

## 7 如何监控微服务调用

### 监控内容

- 用户端监控
- 接口监控
- 资源监控
- 基础监控

### 指标

- 请求量
- 响应时间
- 错误率

### 维度

- 全局维度
- 分机房维度
- 单机维度
- 时间维度
- 核心维度(业务层面)

### 环节

1. 数据采集，包括主动上报和代理收集。注意这块也会影响系统本身的性能
2. 数据传输，UDP、kafka、
3. 数据处理，接口维度聚合、机器维度聚合（索引数据库和时序数据库进行存储）
4. 数据展示，曲线、饼状、格子等

## 8 如何追踪微服务调用

简单地讲就是如何定位错误

### 作用

- 优化性能瓶颈
- 优化链路调用
- 生成网络拓扑
- 透明数据传输

### 服务追踪系统原理

- Dapper 是鼻祖，其它都是衍生出来的，包括 Twitter 的 Zipkin，阿里的鹰眼，美团的 MTrace，首先，需要了解几个概念，traceId（请求）、spanId（调用顺序编号）、annotation（埋点）
- 数据采集，![https://tech.meituan.com/img/mt-mtrace/mtrace9.png](https://tech.meituan.com/img/mt-mtrace/mtrace9.png)
- 数据处理
  - 实时[OLTP(HBase)+Storm/Spark Streaming]
  - 离线[Hive+MapReduceSpark 批处理程序]
- 数据展示
  - 链路图
  - 拓扑图
