## 25 微服务为什么要容器化

DevOps 事实上就是开发与运维的结合，运维遇到的问题很多情况下是系统环境和软件环境的不一致。

- 容器就像运行在宿主机上的另一个操作系统
- Docker 不仅可以打包应用程序本身，还可以打包应用程序的所有依赖，甚至操作系统

### 容器化实践

- 利用 Docker 镜像分层机制，共用相关环境，逐层打包
  - 基础环境层 (OS)
  - 运行环境层 (java)
  - Web 容器层 (tomcat)
  - 业务代码层

### 两个问题

- 测试和发布工作量提升
- 由于环境差异导致的复杂度提升

## 26 微服务容器化运维：镜像仓库和资源调度

容器化天生就是为微服务而生，

- Puppet，在使用容器用的是这个工具进行发布
- 私有化镜像仓库对大团队来说很有必要
  - 权限控制
    - 登录
    - 按项目划分（开发者、管理员、Guest）
  - 镜像同步
    - 主从复制
    - P2P
  - 高可用性
    - 实现多 IDC 部署
  - 资源调度，使用 Docker Machine 可以解决，但是不适合跑了一段时间业务的。往往需要开发一层 DCP
    - 物理机集群(12 核 16G --> 32 核 32 G)
    - 虚拟机集群（ 如基于 Open Stack ）
    - 公有云集群
    - 开始时可以借助 Ansible 等软件对机器进行配置分发进行基本软件安装与配置

## 27 微服务容器化运维：容器调度和服务编排

适用于成百上千机器的部署，开源的主要有：

- Docker Swarm，门槛低
- MesosPhere Mesos
- 谷歌 Kubernetes，门槛较高

需要解决的问题

- 主机过滤
  - 存活过滤
  - 硬件过滤，根据机器特性
- 调度策略 spread/binpack

### 服务编排

- 服务依赖，参考 docker-compose
- 服务发现
  - 基于 Ngnix reload，可惜延迟较大
  - 基于注册中心
- 自动扩缩容
